
---
- name: Setup Datadog Agent
  hosts: nas
  become: yes
  become_user: root
  become_method: sudo
  gather_facts: yes

  tasks:
    - include_role:
        name: datadog.datadog
      vars:
        datadog_api_key: "{{ lookup('community.general.onepassword', 'Datadog Nasberry', field='datadog_api_key') }}"
        datadog_site: "{{ lookup('community.general.onepassword', 'Datadog Nasberry', field='datadog_site') }}"
        # /etc/datadog-agent/datadog.yaml
        datadog_config:
          logs_enabled: "true"
          logs:
            - type: file
              path: /var/log/nginx/access.log
              service: nginx
              source: nginx

            - type: file
              path: /var/log/nginx/error.log
              service: nginx
              source: nginx

          process_config:
            enabled: true
            process_discovery:
              enabled: true
            custom_sensitive_words: ['personal_key', '*token', 'sql*', '*pass*d*']

        # /etc/datadog-agent/conf.d/<check_name>.d/conf.yaml
        datadog_checks:
          process:
            init_config:
            instances:
              - name: ssh
                search_string: ['ssh', 'sshd']
              - name: tailscale
                search_string: ['tailscale', 'tailscaled']
              - name: minio
                search_string: ['minio', 'mc']

          openmetrics:
            instances:
              - openmetrics_endpoint: http://localhost:9000/minio/v2/metrics/cluster
                namespace: "minio_cluster"
                metrics: [".*"]

              - openmetrics_endpoint: http://localhost:9000/minio/v2/metrics/node
                namespace: "minio_node"
                metrics: [".*"]
