---
- name: Setup Nomad Client
  hosts: nomadClients
  become: yes
  become_user: root
  become_method: sudo
  gather_facts: no

  handlers:
    - name: Restart Nomad
      service: name=nomad state=restarted

  tasks:
    - blockinfile:
        path: /etc/nomad.d/client.hcl
        create: yes
        mode: 0700
        block: |
          client {
            enabled = true

            options = {
              "driver.denylist" = "java"
            }

            server_join {
              retry_join = [ {% for i in groups['nomadServers'] %}"{{ i }}:4647",{% endfor %} ]
              retry_interval = "15s"
            }
          }

          plugin "raw_exec" {
            config {
              enabled = true
            }
          }
      notify: Restart Nomad
