---
- name: Setup Nomad Client
  hosts: nomadClients
  become: yes
  become_user: root
  become_method: sudo
  gather_facts: no

  handlers:
    - name: Reload Nomad
      service: name=nomad state=reloaded

  tasks:
    - blockinfile:
        path: /etc/nomad.d/client.hcl
        create: yes
        mode: 0700
        block: |
          client {
            enabled = true

            options = {
              "driver.denylist" = "java"
            }

            servers = [{% for i in groups['nomadServers'] %}"{{ i }}:4647",{% endfor %}]
          }

          plugin "raw_exec" {
            config {
              enabled = true
            }
          }
      notify: Reload Nomad
